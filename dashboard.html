<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Smart Plug Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white font-sans">

  <div class="max-w-5xl mx-auto p-6 space-y-8">
    <h1 class="text-3xl font-bold">üîå Smart Plug Power Dashboard</h1>

    <!-- Stats -->
    <div class="grid grid-cols-4 gap-4 text-center">
      <div class="bg-gray-800 p-4 rounded-xl shadow">
        <div class="text-lg">‚ö° Watt</div>
        <div id="wattLive" class="text-2xl font-bold text-green-400">--</div>
      </div>
      <div class="bg-gray-800 p-4 rounded-xl shadow">
        <div class="text-lg">üîã Voltage</div>
        <div id="voltageLive" class="text-2xl font-bold text-blue-400">--</div>
      </div>
      <div class="bg-gray-800 p-4 rounded-xl shadow">
        <div class="text-lg">üîå Current</div>
        <div id="currentLive" class="text-2xl font-bold text-yellow-400">--</div>
      </div>
      <div class="bg-gray-800 p-4 rounded-xl shadow">
        <div class="text-lg">‚öôÔ∏è Total Energy</div>
        <div id="totalKWh" class="text-2xl font-bold text-pink-400">--</div>
      </div>
    </div>

    <!-- Excel aggregate stats -->
    <div class="grid grid-cols-4 gap-4 text-center mt-4">
      <div class="bg-gray-800 p-3 rounded-xl shadow">
        <div class="text-sm">Excel: Last 1 Hour</div>
        <div id="excelLastHour" class="text-lg font-bold text-indigo-300">-- kWh</div>
      </div>
      <div class="bg-gray-800 p-3 rounded-xl shadow">
        <div class="text-sm">Excel: Last 24 Hours</div>
        <div id="excel24h" class="text-lg font-bold text-indigo-300">-- kWh</div>
      </div>
      <div class="bg-gray-800 p-3 rounded-xl shadow">
        <div class="text-sm">Excel: Last 7 Days</div>
        <div id="excel7d" class="text-lg font-bold text-indigo-300">-- kWh</div>
      </div>
      <div class="bg-gray-800 p-3 rounded-xl shadow">
        <div class="text-sm">Excel: All (Total)</div>
        <div id="excelAll" class="text-lg font-bold text-indigo-300">-- kWh</div>
      </div>
    </div>

    <!-- Device control -->
    <div class="mt-6 flex items-center space-x-4">
      <div class="bg-gray-800 p-4 rounded-xl shadow">
        <div class="text-sm">Smart Plug Control</div>
        <div class="mt-2">
          <label class="inline-flex items-center cursor-pointer">
            <input id="deviceToggle" type="checkbox" class="hidden" />
            <span id="toggleVisual" class="w-14 h-8 bg-gray-600 rounded-full relative transition-colors">
              <span id="toggleKnob" class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full shadow transform transition-transform"></span>
            </span>
            <span id="deviceStatus" class="ml-3 text-sm text-green-300">--</span>
          </label>
        </div>
      </div>
      <div class="text-sm text-gray-400">Toggle to switch the plug ON/OFF. Changes apply immediately.</div>
    </div>

    <!-- Charts -->
    <div class="space-y-6">
      <canvas id="wattChart" height="120"></canvas>
      <canvas id="voltageChart" height="120"></canvas>
      <canvas id="currentChart" height="120"></canvas>
      <h2 class="text-xl font-bold mt-8 ">üìä Energy Usage (Last 60 Minutes)</h2>
      <canvas id="minutelyBarChart" height="120"></canvas>

      <h2 class="text-xl font-bold mt-8">Power, Current & Voltage Over Time</h2>
      <canvas id="multiLineChart" height="120"></canvas>

      <h2 class="text-xl font-bold mt-8">üìà Stacked Area Chart: Current, Watt, Voltage & Total kWh</h2>
      <canvas id="stackedAreaChart" height="250"></canvas>

  <h2 class="text-xl font-bold mt-8">üîé Excel: Minutely Energy Report</h2>
  <canvas id="excelChart" height="160"></canvas>

    </div>
  </div>

  <script>

    const wattCtx = document.getElementById('wattChart').getContext('2d');
    const voltageCtx = document.getElementById('voltageChart').getContext('2d');
    const currentCtx = document.getElementById('currentChart').getContext('2d');
    //minute chart
    const minutelyCtx = document.getElementById('minutelyBarChart').getContext('2d');
    // <-- Added this missing line -->
    const multiLineCtx = document.getElementById('multiLineChart').getContext('2d');

    //stack chart
    const stackedAreaCtx = document.getElementById('stackedAreaChart').getContext('2d');

    const wattChart = new Chart(wattCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Watt (W)', data: [], borderColor: '#4ade80', fill: false }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    const voltageChart = new Chart(voltageCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Voltage (V)', data: [], borderColor: '#60a5fa', fill: false }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    const currentChart = new Chart(currentCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Current (mA)', data: [], borderColor: '#facc15', fill: false }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    //minute chart
    const minutelyBarChart = new Chart(minutelyCtx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'Energy (kWh)',
          data: [],
          backgroundColor: '#f87171' // red-ish
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true },
          x: { ticks: { maxRotation: 90, minRotation: 45 } }
        }
      }
    });

    const multiLineChart = new Chart(multiLineCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Watt (W)',
            data: [],
            borderColor: '#4ade80',
            yAxisID: 'y',
            fill: false
          },
          {
            label: 'Voltage (V)',
            data: [],
            borderColor: '#60a5fa',
            yAxisID: 'y',
            fill: false
          },
          {
            label: 'Current (mA)',
            data: [],
            borderColor: '#facc15',
            yAxisID: 'y1',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false
        },
        stacked: false,
        plugins: {
          title: {
            display: true,
            text: 'Watt, Voltage & Current (Secondary Axis for Current)'
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              parser: false,
              tooltipFormat: 'HH:mm:ss.SSS',
              displayFormats: {
                millisecond: 'HH:mm:ss.SSS',
                second: 'HH:mm:ss',
                minute: 'HH:mm'
              }
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Watt / Voltage'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false // disables y1 grid overlap
            },
            title: {
              display: true,
              text: 'Current (mA)'
            }
          }
        }
      }
    });

    // Configure time scale for charts to show milliseconds when available
    Chart.defaults.plugins.tooltip.mode = 'index';
    Chart.defaults.plugins.tooltip.intersect = false;



    //stacked area chart

    const stackedAreaChart = new Chart(stackedAreaCtx, {
      type: 'line',
      data: {
        labels: [], // timestamps (HH:MM:SS)
        datasets: [
          {
            label: 'Watt (W)',
            data: [],
            borderColor: 'rgba(74, 222, 128, 0.8)', // green
            backgroundColor: 'rgba(74, 222, 128, 0.4)',
            fill: true,
            stack: 'combined',
            tension: 0.3,
          },
          {
            label: 'Current (mA)',
            data: [],
            borderColor: 'rgba(250, 204, 21, 0.8)', // yellow
            backgroundColor: 'rgba(250, 204, 21, 0.4)',
            fill: true,
            stack: 'combined',
            tension: 0.3,
          },
          
          {
            label: 'Voltage (V)',
            data: [],
            borderColor: 'rgba(96, 165, 250, 0.8)', // blue
            backgroundColor: 'rgba(96, 165, 250, 0.4)',
            fill: true,
            stack: 'combined',
            tension: 0.3,
          },
          {
            label: 'Total kWh',
            data: [],
            borderColor: 'rgba(236, 72, 153, 0.8)', // pink
            backgroundColor: 'rgba(236, 72, 153, 0.4)',
            fill: true,
            stack: 'combined',
            tension: 0.3,
            yAxisID: 'y1', // Use a secondary Y axis because total kWh range is different
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false
        },
        stacked: true,
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            min: 5,
            title: {
              display: true,
              text: 'Current (mA), Watt (W), Voltage (V)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false
            },
            title: {
              display: true,
              text: 'Total kWh'
            }
          }
        }
      }
    });

    // Excel-sourced chart (from full_energy_report.xlsx -> "Minutely Report")
    const excelCtx = document.getElementById('excelChart').getContext('2d');
    const excelChart = new Chart(excelCtx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'Minutely Total kWh',
          data: [],
          backgroundColor: '#60a5fa'
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });


    async function updateCharts() {
      const res = await fetch('/api/data');
      const data = await res.json();

      // Use full ISO timestamps so time scale (luxon adapter) can display milliseconds
      const labels = data.map(d => d.timestamp);
      const watts = data.map(d => d.watt);
      const volts = data.map(d => (d.voltage !== null && d.voltage !== undefined) ? (d.voltage / 10) : null); // adjust if needed
      const currents = data.map(d => d.current);

      document.getElementById('wattLive').textContent = watts.at(-1) + " W";
      document.getElementById('voltageLive').textContent = volts.at(-1).toFixed(1) + " V";
      document.getElementById('currentLive').textContent = currents.at(-1).toFixed(3) + " mA";

  // Set labels to ISO timestamps; Chart.js time scale will format them
  wattChart.data.labels = labels;
  wattChart.data.datasets[0].data = watts;

  voltageChart.data.labels = labels;
  voltageChart.data.datasets[0].data = volts;

  currentChart.data.labels = labels;
  currentChart.data.datasets[0].data = currents;

  multiLineChart.data.labels = labels;
  multiLineChart.data.datasets[0].data = watts;
  multiLineChart.data.datasets[1].data = volts;
  multiLineChart.data.datasets[2].data = currents;

      // Fetch total kWh once per update
      const totalKWhRes = await fetch('/api/total-kwh');
      const totalKWhData = await totalKWhRes.json();

      const totalKWhArr = Array(data.length).fill(totalKWhData.total_kwh);

      stackedAreaChart.data.labels = labels;
      stackedAreaChart.data.datasets[0].data = watts.map(w => w);
      stackedAreaChart.data.datasets[1].data = currents;
      
      stackedAreaChart.data.datasets[2].data = volts;
      stackedAreaChart.data.datasets[3].data = totalKWhArr;

      // Update all charts
      wattChart.update();
      voltageChart.update();
      currentChart.update();
      multiLineChart.update();
      stackedAreaChart.update();
    }


    // Fetch latest values from Excel and update stat cards
    async function updateExcelStats() {
      try {
        const res = await fetch('/api/excel-latest');
        if (!res.ok) return;
        const d = await res.json();
        if (d.watt !== null && d.watt !== undefined) document.getElementById('wattLive').textContent = d.watt + ' W';
        if (d.voltage !== null && d.voltage !== undefined) document.getElementById('voltageLive').textContent = d.voltage + ' V';
        if (d.current !== null && d.current !== undefined) document.getElementById('currentLive').textContent = d.current + ' mA';
        if (d.kwh !== null && d.kwh !== undefined) document.getElementById('totalKWh').textContent = d.kwh + ' kWh';
      } catch (e) {
        console.debug('Failed to fetch excel latest', e);
      }
    }


    async function updateTotalKWh() {
      const res = await fetch('/api/total-kwh');
      const data = await res.json();
      const el = document.getElementById('totalKWh');
      // Parse current numeric value (strip non-numeric)
      const currentText = el.textContent || '';
      const currentNum = parseFloat(currentText.replace(/[^(0-9\.)-]/g, '')) || 0;
      const targetNum = Number(data.total_kwh) || 0;

      // Animate change over duration (ms)
      function animateValue(start, end, duration) {
        const startTime = performance.now();
        function step(now) {
          const elapsed = now - startTime;
          const t = Math.min(elapsed / duration, 1);
          // easeOutQuad for smoother finish
          const eased = 1 - (1 - t) * (1 - t);
          const value = start + (end - start) * eased;
          el.textContent = value.toFixed(6).replace(/\.0+$/, '') + ' kWh';
          if (t < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      // Only animate when change is meaningful
      if (Math.abs(targetNum - currentNum) > 0.000001) {
        animateValue(currentNum, targetNum, 4000); // 4 seconds
      } else {
        el.textContent = targetNum + ' kWh';
      }
    }

    async function updateMinutelyStats() {
      const res = await fetch('/api/stats/minutely');
      const stats = await res.json();

      minutelyBarChart.data.labels = stats.map(s => s.minute.slice(11)); // show only HH:MM
      minutelyBarChart.data.datasets[0].data = stats.map(s => s.total_kwh);
      minutelyBarChart.update();
    }


    // Fetch and render the Excel-sourced minutely report
    async function updateExcelChart() {
      const res = await fetch('/api/excel-graph-data');
      if (!res.ok) {
        console.warn('Excel data not available');
        return;
      }
      const data = await res.json();
      // data: [{minute: 'HH:MM', total_kwh: 0.000123}, ...]
      excelChart.data.labels = data.map(d => d.minute);
      excelChart.data.datasets[0].data = data.map(d => d.total_kwh);
      // Also populate the existing minutely bar chart so dashboard shows Excel values
      try {
        minutelyBarChart.data.labels = data.map(d => d.minute);
        minutelyBarChart.data.datasets[0].data = data.map(d => d.total_kwh);
        minutelyBarChart.update();
      } catch (e) {
        console.debug('Failed to update minutelyBarChart from Excel data', e);
      }
      excelChart.update();
    }


    // Fetch Excel aggregates (totals over various ranges) and update UI
    let lastExcelMtime = null;
    async function updateExcelAggregates(force=false) {
      try {
        const res = await fetch('/api/excel-aggregates');
        if (!res.ok) return;
        const d = await res.json();
        // if file changed since last read, or forced, refresh
        if (force || lastExcelMtime !== d.file_mtime) {
          lastExcelMtime = d.file_mtime;
          document.getElementById('excelLastHour').textContent = (d.last_hour_kwh ?? 0).toFixed(6) + ' kWh';
          document.getElementById('excel24h').textContent = (d.last_24h_kwh ?? 0).toFixed(6) + ' kWh';
          document.getElementById('excel7d').textContent = (d.last_7d_kwh ?? 0).toFixed(6) + ' kWh';
          document.getElementById('excelAll').textContent = (d.total_kwh ?? 0).toFixed(6) + ' kWh';
          // also update the Total Energy stat with the aggregate total
          document.getElementById('totalKWh').textContent = (d.total_kwh ?? 0).toFixed(6) + ' kWh';
        }
      } catch (e) {
        console.debug('Failed to fetch excel aggregates', e);
      }
    }


    // Device control wiring
    async function refreshDeviceState() {
      try {
        const res = await fetch('/api/device/state');
        if (!res.ok) return;
        const d = await res.json();
        const chk = document.getElementById('deviceToggle');
        const status = document.getElementById('deviceStatus');
        const knob = document.getElementById('toggleKnob');
        const visual = document.getElementById('toggleVisual');

        if (d && d.power !== null && d.power !== undefined) {
          chk.checked = !!d.power;
          if (chk.checked) {
            visual.classList.remove('bg-gray-600');
            visual.classList.add('bg-green-500');
            knob.style.transform = 'translateX(24px)';
            status.textContent = 'ON';
          } else {
            visual.classList.remove('bg-green-500');
            visual.classList.add('bg-gray-600');
            knob.style.transform = 'translateX(0px)';
            status.textContent = 'OFF';
          }
        } else {
          status.textContent = 'Unknown';
        }
      } catch (e) {
        console.debug('Failed to refresh device state', e);
      }
    }

    document.getElementById('deviceToggle').addEventListener('change', async function (ev) {
      const checked = ev.target.checked;
      const status = document.getElementById('deviceStatus');
      const visual = document.getElementById('toggleVisual');
      const knob = document.getElementById('toggleKnob');
      try {
        const url = checked ? '/api/device/on' : '/api/device/off';
        const res = await fetch(url, { method: 'POST' });
        const data = await res.json();
        if (res.ok && data.result === 'ok') {
          // reflect change in UI
          if (checked) {
            visual.classList.remove('bg-gray-600');
            visual.classList.add('bg-green-500');
            knob.style.transform = 'translateX(24px)';
            status.textContent = 'ON';
          } else {
            visual.classList.remove('bg-green-500');
            visual.classList.add('bg-gray-600');
            knob.style.transform = 'translateX(0px)';
            status.textContent = 'OFF';
          }
        } else {
          // revert checkbox if call failed
          ev.target.checked = !checked;
          status.textContent = 'Error';
          console.error('Device command failed', data);
        }
      } catch (e) {
        ev.target.checked = !checked;
        status.textContent = 'Error';
        console.debug('Failed to send device command', e);
      }
    });


    setInterval(() => {
      updateCharts();
      updateExcelChart();
      updateExcelStats();
    }, 5000);

    // Update the total kWh less frequently and with smooth animation
    setInterval(updateTotalKWh, 15000); // every 15 seconds

    // Poll Excel aggregates every 15s; will update UI when file changes
    setInterval(updateExcelAggregates, 15000);

    setInterval(updateMinutelyStats, 60000); // refresh every 60s
  updateCharts();
  updateTotalKWh();
  updateMinutelyStats();
  updateExcelChart();
  updateExcelStats();
  updateExcelAggregates();
  </script>
</body>

</html>
